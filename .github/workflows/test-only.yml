name: Test Only
run-name: "ðŸ§ª Tests for run #${{ inputs.run_id }}"

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Workflow run ID'
        required: true
        type: string
      test_timeout:
        description: 'Test timeout in seconds'
        required: false
        type: number
        default: 300

permissions:
  contents: read
  actions: read

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.get-artifacts.outputs.matrix }}
    steps:
      - name: Get artifacts from run
        id: get-artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const runId = ${{ inputs.run_id }};
            const { data } = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const builds = data.artifacts
              .filter(a => a.name.startsWith('Build-'))
              .map(a => {
                const match = a.name.match(/^Build-(.+)-(.+)$/);
                if (match) {
                  return {
                    artifact_name: a.name,
                    unity_version: match[1],
                    platform: match[2]
                  };
                }
                return null;
              })
              .filter(Boolean);

            if (builds.length === 0) {
              core.setFailed('No Build-* artifacts found in run ' + runId);
              return;
            }

            console.log('Found builds:', JSON.stringify(builds, null, 2));
            core.setOutput('matrix', JSON.stringify({ include: builds }));

  test:
    needs: setup
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    runs-on: ${{
      matrix.platform == 'StandaloneWindows64' && 'windows-latest' ||
      matrix.platform == 'StandaloneOSX' && 'macos-14' ||
      matrix.platform == 'iOS' && 'macos-14' ||
      'ubuntu-latest'
      }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          sparse-checkout: |
            .github/actions
            .github/scripts
            Assets/server.js
            Assets/UniText.Test

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: build
          github-token: ${{ secrets.GH_PAT }}
          run-id: ${{ inputs.run_id }}

      - name: Authenticate to Google Cloud (Android/iOS)
        if: matrix.platform == 'Android' || matrix.platform == 'iOS'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}

      - name: Setup Google Cloud SDK (Android/iOS)
        if: matrix.platform == 'Android' || matrix.platform == 'iOS'
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.FIREBASE_PROJECT_ID }}

      - name: Install gcloud beta (iOS)
        if: matrix.platform == 'iOS'
        run: gcloud components install beta --quiet

      - name: Run Tests
        uses: ./.github/actions/run-tests
        env:
          FIREBASE_RESULTS_BUCKET: ${{ secrets.FIREBASE_RESULTS_BUCKET }}
          # iOS secrets
          GH_PAT: ${{ secrets.GH_PAT }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
          APP_IDENTIFIER: ${{ secrets.APP_IDENTIFIER }}
          TEAM_ID: ${{ secrets.TEAM_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        with:
          platform: ${{ matrix.platform }}
          unity_version: ${{ matrix.unity_version }}
          test_timeout: ${{ inputs.test_timeout }}

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TestResults-${{ matrix.unity_version }}-${{ matrix.platform }}
          path: |
            testResults.xml
            test.log
            xcodebuild.log
          retention-days: 7
